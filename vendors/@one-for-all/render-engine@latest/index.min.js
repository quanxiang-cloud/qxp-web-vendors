System.register(["react","@one-for-all/utils","rxjs","rxjs/operators","rxjs/ajax","react-dom"],(function(e){"use strict";var t,r,n,o,a,c,i,s,l,u,p,d,f,h,b,m,y,g,v,S,x,j,$,k,O,w,E,P,_,N,H,I,L;return{setters:[function(e){t=e.default,r=e.useRef,n=e.useState,o=e.useEffect,a=e.useMemo,c=e.useContext,i=e.useImperativeHandle},function(e){s=e.logger},function(e){l=e.switchMap,u=e.share,p=e.map,d=e.catchError,f=e.of,h=e.BehaviorSubject,b=e.Subject,m=e.noop,y=e.from,g=e.firstValueFrom,v=e.combineLatest,S=e.take,x=e.last,j=e.combineLatestWith,$=e.skip,k=e.tap,O=e.distinctUntilKeyChanged,w=e.distinctUntilChanged},function(e){E=e.map,P=e.filter,_=e.share,N=e.skip,H=e.delay},function(e){I=e.ajax},function(e){L=e.default}],execute:function(){function A(){return A=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},A.apply(this,arguments)}var D;e("SchemaRender",(function({schema:e,plugins:r},a){const c=function(e,t){const[r,a]=n(null);return o((()=>{Oe({plugins:t,schema:e}).then(a).catch(s.error)}),[]),r}(e,r);if(i(a,(()=>{if(c)return{apiStates:c.ctx.apiStates,states:c.ctx.states,history:c.ctx.history}}),[c]),!c)return null;return t.createElement(et,{node:c.rootNode,ctx:c.ctx})})),function(e){e.Pop="POP",e.Push="PUSH",e.Replace="REPLACE"}(D||(D={}));var R="beforeunload";function C(e){e.preventDefault(),e.returnValue=""}function V(){var e=[];return{get length(){return e.length},push:function(t){return e.push(t),function(){e=e.filter((function(e){return e!==t}))}},call:function(t){e.forEach((function(e){return e&&e(t)}))}}}var F=Object.defineProperty,K=Object.defineProperties,U=Object.getOwnPropertyDescriptors,W=Object.getOwnPropertySymbols,T=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable,z=(e,t,r)=>t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;function M(e){return new Proxy({},{get:(t,r)=>{const n=e.getState$(r).getValue();return o=((e,t)=>{for(var r in t||(t={}))T.call(t,r)&&z(e,r,t[r]);if(W)for(var r of W(t))q.call(t,r)&&z(e,r,t[r]);return e})({},n),K(o,U({fetch:(t,n)=>{e.fetch(r,{params:t,callback:n})},refresh:()=>e.refresh(r)}));var o}})}function X(e){return"[object Object]"===Object.prototype.toString.call(e)}function B(e,t){if("expression"in e&&"state_convert_expression"===e.type)return function(e,t){try{const r=new Function("state",`return ${e}`).bind(t);return r.toString=()=>["","function wrappedStateConvertor(state) {",`\treturn ${e}`,"}"].join("\n"),r}catch(t){throw new Error(["failed to instantiate state convert expression:","\n",e,"\n",t].join(""))}}(e.expression,t);try{const r=new Function(e.args,e.body).bind(t);return r.toString=()=>["",`function wrappedFunc(${e.args}) {`,`\t${e.body}`,"}",""].join("\n"),r}catch(t){throw new Error(["failed to instantiate function of following spec:","\n","spec.args:",e.args,"\n","spec.body:","\n",e.body,"\n",t].join(""))}}function J(e,t){return X(e)&&"object"==typeof e&&null!==e?(Object.entries(e).forEach((([r,n])=>{!function(e){return!(!X(e)||"object"!=typeof e||null===e)&&("type"in e&&"state_convert_expression"===Reflect.get(e,"type")||3===Object.keys(e).length&&"type"in e&&"args"in e&&"body"in e)}(n)?X(n)?Reflect.set(e,r,J(n,t)):Array.isArray(n)&&Reflect.set(e,r,n.map((e=>J(e,t)))):Reflect.set(e,r,B(n,t))})),e):e}function Z(e,t){try{return J(JSON.parse(JSON.stringify(e)),t)}catch(e){return s.error(e),null}}function G(e){return I(e).pipe(p((({response:e})=>({result:e,error:void 0}))),d((e=>f({error:e,data:void 0}))))}var Q=Object.defineProperty,Y=Object.defineProperties,ee=Object.getOwnPropertyDescriptors,te=Object.getOwnPropertySymbols,re=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable,oe=(e,t,r)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ae=(e,t)=>{for(var r in t||(t={}))re.call(t,r)&&oe(e,r,t[r]);if(te)for(var r of te(t))ne.call(t,r)&&oe(e,r,t[r]);return e},ce=(e,t)=>Y(e,ee(t));const ie={result:void 0,error:void 0,loading:!1};function se(e,t){const r=new h(ie),n=function(e){return e.pipe(l(G),u())}(e);return n.pipe(E((({result:e,error:t})=>({result:e,error:t,loading:!1}))),E((e=>{if(!t)return e;const r=t({body:e.result,error:e.error});return ce(ae({},r),{loading:e.loading})}))).subscribe(r),e.pipe(P((()=>!1===r.getValue().loading)),E((()=>ce(ae({},r.getValue()),{loading:!0})))).subscribe(r),r}function le(e,t){const r=new b;let n;const o=se(r.pipe(E((r=>t.build(e,r))),P(Boolean),_()),t.responseAdapter);return o.pipe(N(1),P((({loading:e})=>!e)),H(10)).subscribe((e=>{var t;null==(t=null==n?void 0:n.callback)||t.call(n,e)})),{state$:o,fetch:e=>{n=e,r.next(e.params)},refresh:()=>{n&&(n={params:n.params},r.next(n.params))}}}const ue={state$:new h(ie),fetch:m,refresh:m},pe={build:()=>({url:"/api",method:"get"})};class de{constructor({apiStateSpec:e,apiSpecAdapter:t},r){this.parentHub=void 0,this.parentHub=r,this.cache=Object.entries(e).reduce(((e,[r,{apiID:n}])=>(e[r]=le(n,t||pe),e)),{})}hasState$(e){var t;return!!this.cache[e]||!!(null==(t=this.parentHub)?void 0:t.hasState$(e))}findState$(e){var t;return this.cache[e]?this.cache[e]:null==(t=this.parentHub)?void 0:t.findState$(e)}getState$(e){const{state$:t}=this.findState$(e)||{};return t||(s.error([`can't find api state: ${e}, please check apiStateSpec or parent schema.`,"In order to prevent UI crash, a dummyState$ will be returned."].join(" ")),ue.state$)}fetch(e,t){const{fetch:r}=this.findState$(e)||{};r?r(t):s.error([`can't find api state: ${e}, please check apiStateSpec or parent schema,`,"this fetch action will be ignored."].join(" "))}refresh(e){const{refresh:t}=this.findState$(e)||{};t?t():s.error([`can't find api state: ${e}, please check apiStateSpec or parent schema,`,"this refresh action will be ignored."].join(" "))}}function fe(e){return new Proxy({},{get:(t,r)=>e.getState$(r).value,set:(t,r,n)=>r.startsWith("$")?(s.error("node internal state can not be assigned"),!1):(e.mutateState(r,n),!0)})}class he{constructor(e,t){this.parentHub=void 0,this.unWriteableStates=[],this.parentHub=t,this.cache=Object.entries(e).reduce(((e,[t,{initial:r,writeable:n}])=>(e[t]=new h(r),!1===n&&this.unWriteableStates.push(t),e)),{})}hasState$(e){var t;return!!this.cache[e]||!!(null==(t=this.parentHub)?void 0:t.hasState$(e))}_createState$(e,t){this.cache[e]=new h(t)}findState$(e){var t;return this.cache[e]?this.cache[e]:null==(t=this.parentHub)?void 0:t.findState$(e)}getState$(e){const t=this.findState$(e);return t||(this._createState$(e),this.cache[e])}mutateState(e,t){e.startsWith("$")?s.warn("shared stateID can not starts with $, this action will be ignored"):this.unWriteableStates.includes(e)?s.warn("this shared state is not allowed to be written, this action will be ignored"):this.getState$(e).next(t)}getNodeState$(e){const t=`$${e}`;return this.getState$(t)}exposeNodeState(e,t){const r=`$${e}`;this.cache[r]?this.cache[r].next(t):this._createState$(r,t)}}var be=Object.defineProperty,me=Object.defineProperties,ye=Object.getOwnPropertyDescriptors,ge=Object.getOwnPropertySymbols,ve=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable,xe=(e,t,r)=>t in e?be(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;function je(e,t,r){const{state$:n,fetch:o}=le(t,e),a=n.pipe(S(2),x(),p((({result:e})=>e)));return o({params:r}),a}function $e(e,t,r){return e.map((({stateID:e,func:n,dependencies:o})=>{const a=function(e,t,r){const n=Object.entries(e).map((([e,n])=>{if(!t[e])return void s.error(`no state: ${e} found in APIStatesSpec, undefined will be used as this dependency value`);const{apiID:o}=t[e];return[e,je(r,o,n)]})).filter((e=>!!e)).reduce(((e,[t,r])=>(e[t]=r,e)),{});return Object.keys(n).length?v(n):f({})}(o||{},t,r),c=a.pipe(l((e=>y(function(e){return t=>Promise.resolve((()=>{try{return e(t)}catch(e){return}})())}(n)(e)))));return[e,c]})).reduce(((e,[t,r])=>(e[t]=r,e)),{})}function ke(e){return Object.entries(e).map((([e,{initializer:t}])=>{if(t)return r=((e,t)=>{for(var r in t||(t={}))ve.call(t,r)&&xe(e,r,t[r]);if(ge)for(var r of ge(t))Se.call(t,r)&&xe(e,r,t[r]);return e})({},t),me(r,ye({stateID:e}));var r})).filter((e=>!!e))}async function Oe({schema:e,parentCTX:t,plugins:r}){var n,o,a;const{apiStateSpec:c,sharedStatesSpec:i}=e,{apiSpecAdapter:s,repository:l,refLoader:u,componentLoader:p}=r||{},d=new de({apiSpecAdapter:s,apiStateSpec:c||{}},null==t?void 0:t.statesHubAPI),f=Z(i||{},void 0),b=await async function(e,t,r){if(!r)return e;const n=$e(ke(e),t,r);if(!Object.keys(n).length)return e;const o=await g(v(n));return Object.entries(o).forEach((([t,r])=>{e[t].initial=r})),e}(f||{},c||{},s),m=new he(b,null==t?void 0:t.statesHubShared),y=(null==t?void 0:t.history)||function(e){void 0===e&&(e={});var t=e.window,r=void 0===t?document.defaultView:t,n=r.history;function o(){var e=r.location,t=e.pathname,o=e.search,a=e.hash,c=n.state||{};return[c.idx,{pathname:t,search:o,hash:a,state:c.usr||null,key:c.key||"default"}]}var a=null;r.addEventListener("popstate",(function(){if(a)p.call(a),a=null;else{var e=D.Pop,t=o(),r=t[0],n=t[1];if(p.length){if(null!=r){var c=s-r;c&&(a={action:e,location:n,retry:function(){y(-1*c)}},y(c))}}else m(e)}}));var c=D.Pop,i=o(),s=i[0],l=i[1],u=V(),p=V();function d(e){return"string"==typeof e?e:(r=(t=e).pathname,n=void 0===r?"/":r,o=t.search,a=void 0===o?"":o,c=t.hash,i=void 0===c?"":c,a&&"?"!==a&&(n+="?"===a.charAt(0)?a:"?"+a),i&&"#"!==i&&(n+="#"===i.charAt(0)?i:"#"+i),n);var t,r,n,o,a,c,i}function f(e,t){return void 0===t&&(t=null),A({pathname:l.pathname,hash:"",search:""},"string"==typeof e?function(e){var t={};if(e){var r=e.indexOf("#");r>=0&&(t.hash=e.substr(r),e=e.substr(0,r));var n=e.indexOf("?");n>=0&&(t.search=e.substr(n),e=e.substr(0,n)),e&&(t.pathname=e)}return t}(e):e,{state:t,key:Math.random().toString(36).substr(2,8)})}function h(e,t){return[{usr:e.state,key:e.key,idx:t},d(e)]}function b(e,t,r){return!p.length||(p.call({action:e,location:t,retry:r}),!1)}function m(e){c=e;var t=o();s=t[0],l=t[1],u.call({action:c,location:l})}function y(e){n.go(e)}return null==s&&(s=0,n.replaceState(A({},n.state,{idx:s}),"")),{get action(){return c},get location(){return l},createHref:d,push:function e(t,o){var a=D.Push,c=f(t,o);if(b(a,c,(function(){e(t,o)}))){var i=h(c,s+1),l=i[0],u=i[1];try{n.pushState(l,"",u)}catch(e){r.location.assign(u)}m(a)}},replace:function e(t,r){var o=D.Replace,a=f(t,r);if(b(o,a,(function(){e(t,r)}))){var c=h(a,s),i=c[0],l=c[1];n.replaceState(i,"",l),m(o)}},go:y,back:function(){y(-1)},forward:function(){y(1)},listen:function(e){return u.push(e)},block:function(e){var t=p.push(e);return 1===p.length&&r.addEventListener(R,C),function(){t(),p.length||r.removeEventListener(R,C)}}}}(),S=(null==t?void 0:t.location$)||new h(y.location);(null==t?void 0:t.location$)||y.listen((({location:e})=>{S.next(e)}));const x={statesHubAPI:d,statesHubShared:m,apiStates:M(d),states:fe(m),history:y,location$:S,plugins:{repository:l||(null==(n=null==t?void 0:t.plugins)?void 0:n.repository),refLoader:u||(null==(o=null==t?void 0:t.plugins)?void 0:o.refLoader),componentLoader:p||(null==(a=null==t?void 0:t.plugins)?void 0:a.componentLoader)}};return{ctx:x,rootNode:Z(e.node,{apiStates:x.apiStates,states:x.states,history:x.history})}}const we=t.createContext("ROOT");function Ee({state:e,convertor:t,fallback:r,propName:n}){var o;if(t&&void 0!==e)try{return null!=(o=t(e))?o:r}catch(o){return s.error(`an error occurred while calling state convertor for prop: "${n}"`,"with the following state and convertor:","\n",e,"\n",t.toString(),"\n","So return fallback instead, fallback:",r,"\n","\n",o),r}return null!=e?e:r}function Pe({props:e},r){return a((()=>Object.entries(e||{}).filter((e=>"render_property"===e[1].type)).reduce(((e,[n,{adapter:o,node:a}])=>(e[n]=function(e,r,n){return(...o)=>{let a={};try{const e=(null==n?void 0:n(...o))||{};"object"==typeof e?a=Object.entries(e).reduce(((e,[t,r])=>(e[t]={type:"constant_property",value:r},e)),{}):s.error("toProps result is no Object")}catch(e){s.error("failed to call toProps",e)}return e.props=Object.assign({},e.props,a),t.createElement(et,{node:e,ctx:r})}}(a,r,o),e)),{})),[])}function _e(e,t){const r={};Object.entries(e.props||{}).filter((e=>"computed_property"===e[1].type)).forEach((([e,{deps:n,convertor:o,fallback:a}])=>{r[e]=function({propName:e,deps:t,convertor:r,ctx:n,fallback:o}){let a=o;const c=t.map((({type:e,depID:t})=>"api_state"===e?n.statesHubAPI.getState$(t):"node_state"===e?n.statesHubShared.getNodeState$(t):n.statesHubShared.getState$(t))),i=c.map((e=>e.value)),s=new h(Ee({state:i,convertor:r,fallback:o,propName:e}));return f(!0).pipe(j(c),p(((t,...n)=>Ee({state:n,convertor:r,fallback:a,propName:e}))),$(1),k((e=>{a=e}))).subscribe((e=>s.next(e))),s}({propName:e,deps:n,convertor:o,ctx:t,fallback:a})}));const[a,c]=n((()=>Object.entries(r).reduce(((e,[t,r])=>(e[t]=r.value,e)),{})));return o((()=>{const e=v(r).pipe($(1)).subscribe(c);return()=>e.unsubscribe()}),[]),a}function Ne(e,t){const i=function(e){return e.props?Object.entries(e.props).filter((e=>"constant_property"===e[1].type)).reduce(((e,[t,{value:r}])=>(e[t]=r,e)),{}):{}}(e),l=function(e,t){const a={},c={},i={};Object.entries(e.props||{}).filter((e=>"api_result_property"===e[1].type)).forEach((([e,{fallback:r,convertor:n,stateID:o}])=>{i[e]=r,a[e]=n,c[e]=t.statesHubAPI.getState$(o)}));const s=r(i),[l,u]=n((()=>Object.entries(c).reduce(((e,[t,r])=>(e[t]=Ee({state:r.getValue().result,convertor:a[t],fallback:s.current[t],propName:t}),e)),{})));return o((()=>{const e=Object.entries(c).reduce(((e,[t,r])=>(e[t]=r.pipe(O("result"),p((({result:e})=>Ee({state:e,convertor:a[t],fallback:s.current[t],propName:t}))),k((e=>{s.current[t]=e}))),e)),{}),t=v(e).pipe($(1)).subscribe(u);return()=>t.unsubscribe()}),[]),l}(e,t),u=function(e,t){const r={};Object.entries(e.props||{}).filter((e=>"api_loading_property"===e[1].type)).forEach((([e,{stateID:n}])=>{r[e]=t.statesHubAPI.getState$(n)}));const[a,c]=n((()=>Object.entries(r).reduce(((e,[t,r])=>(e[t]=r.getValue().loading,e)),{})));return o((()=>{const e=Object.entries(r).reduce(((e,[t,r])=>(e[t]=r.pipe($(1),O("loading"),p((({loading:e})=>e))),e)),{}),t=v(e).subscribe(c);return()=>t.unsubscribe()}),[]),a}(e,t),d=function(e,t){const a={},c={},i={};Object.entries(e.props||{}).filter((e=>"shared_state_property"===e[1].type||"node_state_property"===e[1].type)).forEach((([e,r])=>{"shared_state_property"===r.type?(c[e]=t.statesHubShared.getState$(r.stateID),a[e]=r.convertor):(c[e]=t.statesHubShared.getNodeState$(r.nodePath),a[e]=r.convertor),i[e]=r.fallback}));const s=r(i),[l,u]=n((()=>Object.entries(c).reduce(((e,[t,r])=>(e[t]=Ee({state:r.getValue(),convertor:a[t],fallback:s.current[t],propName:t}),e)),{})));return o((()=>{if(!Object.keys(c).length)return;const e=Object.entries(c).reduce(((e,[t,r])=>(e[t]=r.pipe(w(),p((e=>Ee({state:e,convertor:a[t],fallback:s.current[t],propName:t}))),k((e=>{s.current[t]=e}))),e)),{}),t=v(e).pipe($(1)).subscribe(u);return()=>t.unsubscribe()}),[]),l}(e,t),f=function(e,t){const r=c(we);return a((()=>"supportStateExposure"in e&&e.supportStateExposure?{__exposeState:n=>{t.statesHubShared.exposeNodeState(`${r}/${e.id}`,n)}}:{}),[])}(e,t),h=_e(e,t),b=function(e){return a((()=>e.props?Object.entries(e.props).filter((e=>"functional_property"===e[1].type)).reduce(((t,[r,{func:n}])=>(t[r]=(...t)=>{try{n(...t)}catch(o){s.error(`an error occurred while run node '${e.id}' functional property:`,r,"with the following arguments:","\n",t,"\n","function is:","\n",n.toString(),"\n",o)}},t)),{}):{}),[])}(e),m=function(e,t){return a((()=>e.props?Object.entries(e.props).filter((e=>"shared_state_mutation_property"===e[1].type)).reduce(((e,[r,{stateID:n,convertor:o}])=>(e[r]=function(e){if("function"==typeof o)try{const r=o(e);t.statesHubShared.mutateState(n,r)}catch(e){s.error("failed to run convertor:\n",o.toString(),"\n",e)}else t.statesHubShared.mutateState(n,e)},e)),{}):{}),[])}(e,t),y=function(e,t){return a((()=>e.props?Object.entries(e.props).filter((e=>"api_invoke_property"===e[1].type)).reduce(((e,[r,{stateID:n,paramsBuilder:o,callback:a}])=>(s.warn("hook useAPIInvokeProps has been deprecated, please use hook useFuncProps instead"),e[r]=function(...e){try{const r=(null==o?void 0:o(...e))||{};t.apiStates[n].fetch(r,a)}catch(e){s.log("failed to run convertor or run action:",e)}},e)),{}):{}),[])}(e,t),g=Pe(e,t),S=function(e,t){return"isLink"in e&&e.isLink&&"html-element"===e.type&&"a"===e.name?{onClick:e=>{e.stopPropagation(),e.preventDefault();const r=e.currentTarget.href;r&&t.history.push(r)}}:{}}(e,t);return a((()=>Object.assign(i,y,l,u,d,h,b,m,f,g,S)),[l,d,u,h,i])}function He({didMount:e,willUnmount:t}){o((()=>(e&&e(),()=>{null==t||t()})),[])}function Ie({node:e,ctx:r}){const a=Ne(e,r);He(e.lifecycleHooks||{});const i=c(we),l=function(){const[e,t]=n(null);return o((()=>{let e=!1;return System.import("react-jsx-parser").then((r=>{e||t((()=>r.default))})).catch((e=>{s.error("failed to load dependance react-jsx-parser:",e)})),()=>{e=!0}})),e}();return e.jsx?l?t.createElement(l,{bindings:a,renderInWrapper:!1,jsx:e.jsx,onError:e=>console.log(e)}):null:(s.error("jsx string is required,",`please check the spec of node: ${i}.`),null)}function Le({node:e,ctx:r}){He(e.lifecycleHooks||{});const a=function({schemaID:e,refLoader:t,orphan:r},a){const[i,l]=n(),u=c(we);return o((()=>{if(!e)return void s.error(`schemaID is required on RefNode, please check the spec for node: ${u}`);if(!t)return void s.error("refLoader is required on RefNode in order to get ref schema and corresponding APISpecAdapter,","please implement refLoader and pass it to parent RenderEngine.",`current RefNode path is: ${u}`);let n,o=!1;return t(e).then((({schema:e,plugins:t})=>{if(!o)return n=e,Oe({plugins:t,schema:e,parentCTX:r?void 0:a})})).then((e=>{e&&n&&l({refCTX:e.ctx,refNode:e.rootNode})})).catch((e=>{s.error(e)})),()=>{o=!0}}),[]),i}({schemaID:e.schemaID,refLoader:r.plugins.refLoader,orphan:e.orphan},r);return a?t.createElement(et,{node:a.refNode,ctx:a.refCTX}):e.fallback?t.createElement(et,{node:e.fallback,ctx:r}):null}function Ae({node:e,ctx:r}){const n=Ne(e,r);He(e.lifecycleHooks||{});const o=c(we);return e.name?e.children&&e.children.length?t.createElement(e.name,n,t.createElement(Ye,{nodes:e.children||[],ctx:r})):t.createElement(e.name,n):(s.error("name property is required in html node spec,",`please check the spec of node: ${o}.`),null)}function De(e,t){const r=c(we),n={type:"html-element",id:"dummyLoopContainer",name:"div",props:{iterable:e}},{iterable:o}=Ne(n,t);if(!Array.isArray(o)){const t=r.split("/").pop();return s.error("state is not iterable.",`LoopContainer node [${t}] require a array type state,`,`but got: ${o},`,"please check the follow property spec:\n",e),null}return o}function Re(e,t,r){return"string"==typeof e||"number"==typeof e?e:void 0===e||"function"==typeof e||"boolean"==typeof e?r:"object"==typeof e&&null!==e?Reflect.get(e,t):r}function Ce(e,t,r,n){try{const o=r(e,t);return"object"==typeof o||o?o:(s.error("toProps result should be an object, but got: ${toPropsResult},",`please check the toProps spec of node: ${n},`,"the corresponding node will be skipped for render."),null)}catch(t){return s.error("An error occurred while calling toProps with the following parameter:",e,"\n",`please check the toProps spec of node: ${n},`,"the corresponding node will be skipped for render."),null}}function Ve({iterableState:e,loopKey:r,node:n,ctx:o,toProps:a}){const i=c(we),s=function({iterableState:e,toProps:t,otherProps:r,ctx:n,loopKey:o}){const a=De(e,n),i=c(we);return a?a.map(((e,n)=>{const a=Ce(e,n,t,i);if(!a)return null;const c=Object.entries(a).reduce(((e,[t,r])=>(e[t]={type:"constant_property",value:r},e)),{});return[Re(e,o,n),Object.assign({},r,c)]})).filter((e=>!!e)):null}({iterableState:e,toProps:a,ctx:o,loopKey:r,otherProps:n.props});return s?t.createElement(t.Fragment,null,s.map((([e,r],a)=>{const c=Object.assign({},n,{props:r});return t.createElement(we.Provider,{value:`${i}/${a}`,key:e},t.createElement(et,{key:e,node:c,ctx:o}))}))):null}function Fe({packageName:e,exportName:t}){return System.import(e).then((e=>e[t||"default"])).catch((e=>(s.error("failed to load node component,",e),null)))}function Ke(e,{repository:t,componentLoader:r}){const a=c(we),[i,l]=n((()=>{if(t)return function(e,{packageName:t,packageVersion:r,exportName:n}){var o;return null==(o=e[`${t}@${r}`])?void 0:o[n||"default"]}(t,e)}));return o((()=>{if(i)return;let t=!1;return(r||Fe)({packageName:e.packageName,packageVersion:e.packageVersion,exportName:e.exportName}).then((r=>{t||(r?l((()=>r)):s.error(`got empty component for package: ${e.packageName},`,`exportName: ${e.exportName}, version: ${e.packageVersion}`,`please check the spec for node: ${a}.`))})).catch(s.error),()=>{t=!0}}),[i]),i}function Ue({outLayer:e,ctx:r,children:n}){const o=Ne(e,r);return t.createElement(e.name,o,n)}function We({outLayer:e,ctx:r,children:n}){const o=Ne(e,r),a=Ke(e,r.plugins);return He(e.lifecycleHooks||{}),a?t.createElement(a,o,n):null}function Te({outLayer:e,ctx:r,children:n}){return"html-element"===(null==e?void 0:e.type)?t.createElement(Ue,{outLayer:e,ctx:r},n):"react-component"===(null==e?void 0:e.type)?t.createElement(We,{outLayer:e,ctx:r},n):t.createElement(t.Fragment,null,n)}function qe({node:e,composedState:r,ctx:n,index:o}){const i=function(e,t,r,n){const o=c(we);return a((()=>{const a=Ce(e,r,t,o),c=Object.entries(a||{}).reduce(((e,[t,r])=>(e[t]={type:"constant_property",value:r},e)),{});return Object.assign({},n,c)}),[e,n])}(r,e.toProps,o,e.props),s=Object.assign({},e,{props:i});return t.createElement(et,{node:s,ctx:n})}function ze({iterableState:e,loopKey:r,node:n,ctx:o}){const a=c(we),i=De(e,o);return i?t.createElement(t.Fragment,null,i.map(((e,c)=>{const i=Re(e,r,c);return t.createElement(we.Provider,{value:`${a}/${c}`,key:c},t.createElement(Te,{key:i,outLayer:n.outLayer,ctx:o},(n.nodes||n.children).map(((r,n)=>t.createElement(qe,{node:r,composedState:e,ctx:o,index:n,key:r.id})))))}))):null}function Me({node:e,ctx:r}){He(e.lifecycleHooks||{});const{node:n}=e;return"composed-node"!==n.type&&"toProps"in e?t.createElement(Ve,{iterableState:e.iterableState,loopKey:e.loopKey,node:n,toProps:t=>e.toProps(t),ctx:r}):"composed-node"===n.type?t.createElement(ze,{iterableState:e.iterableState,loopKey:e.loopKey,node:n,ctx:r}):(s.error("Unrecognized loop node:",e),null)}const Xe=t.createContext("/");function Be(e){return e.replace(/^\/|\/$/g,"")}function Je(e){return/^:[a-zA-Z_][[a-zA-Z_$0-9]+$/.test(e)}function Ze(e,t,r){const[a,c]=n(!1);return o((()=>{const n=e.pipe(p((({pathname:e})=>r?function(e,t){const r=e.split("/"),n=t.split("/");return r.length===n.length&&r.every(((e,t)=>!!Je(n[t])||e===n[t]))}(e,t):function(e,t){const r=e.split("/"),n=t.split("/");return!(r.length<n.length)&&n.every(((e,t)=>!!Je(e)||e===r[t]))}(e,t))),w()).subscribe(c);return()=>n.unsubscribe()}),[]),a}function Ge({node:e,ctx:r}){var n;He(e.lifecycleHooks||{});const o=c(Xe),a=(i=o,s=e.path,"/"===i?`/${Be(s)}`:`${i}/${Be(s)}`);var i,s;return Ze(r.location$,a,null!=(n=e.exactly)&&n)?t.createElement(Xe.Provider,{value:a},t.createElement(et,{node:e.node,ctx:r})):null}function Qe({node:e,ctx:r}){const n=Ne(e,r),o=Ke(e,r.plugins);return He(e.lifecycleHooks||{}),o?e.children&&e.children.length?t.createElement(o,n,t.createElement(Ye,{nodes:e.children||[],ctx:r})):t.createElement(o,n):null}function Ye({nodes:e,ctx:r}){return e.length?t.createElement(t.Fragment,null,e.map((e=>t.createElement(et,{key:e.id,node:e,ctx:r})))):null}function et({node:e,ctx:r}){const n=`${c(we)}/${e.id}`,o=function(e,t){const r=e.shouldRender,n={id:"placeholder-node",type:"html-element",name:"div",props:r?{shouldRender:r}:void 0},{shouldRender:o}=Ne(n,t);return!r||("api_loading_property"===r.type&&r.revert?!o:!!o)}(e,r);return o?"route-node"===e.type?t.createElement(we.Provider,{value:n},t.createElement(Ge,{node:e,ctx:r})):"loop-container"===e.type?t.createElement(we.Provider,{value:n},t.createElement(Me,{node:e,ctx:r})):"html-element"===e.type?t.createElement(we.Provider,{value:n},t.createElement(Ae,{node:e,ctx:r})):"react-component"===e.type?t.createElement(we.Provider,{value:n},t.createElement(Qe,{node:e,ctx:r})):"ref-node"===e.type?t.createElement(we.Provider,{value:n},t.createElement(Le,{node:e,ctx:r})):"jsx-node"===e.type?t.createElement(we.Provider,{value:n},t.createElement(Ie,{node:e,ctx:r})):(s.error("Unrecognized node type of node:",e),null):null}class tt{constructor(e,t){this.schema=e,this.plugins=t||{}}async render(e){const{ctx:r,rootNode:n}=await Oe({plugins:this.plugins,schema:this.schema});L.render(t.createElement(et,{node:n,ctx:r}),e)}}e({RenderEngine:tt,default:tt})}}}));
